---
typora-root-url: .
typora-copy-images-to: ..\assets\img
---

# java内存模型与垃圾回收机制

## 一、java内存模型

![Eden  so  4—JVM Heap](/../assets/img/clip_image001-1562053642070.png)

[图源](https://www.journaldev.com/2856/java-jvm-memory-model-memory-management-in-java)

![java内存模型 ](/../assets/img/clip_image002.png)

 

如图所示，java内存模型包含三部分：

1. Java heap：包含新生代老年代两个内存空间，几乎所有的创建的对象都存储在这里
2. Perm Gen：包含永久代内存空间，用于存储运行时的类、常量、静态变量以及方法代码、ClassLoader
3. Java Stack：每个线程启动时，都会创建一个自己的java Stack，用于存储运行堆栈，以及原始类型临时变量，以及线程中用到的对象的引用

 

## 二、内存管理中的各类GC

![Eden  Survivor I  Obj«ts Oder than 'S GC Cycles  Tenured ](/../assets/img/clip_image003.png)

[图源](https://www.javacodegeeks.com/2015/03/minor-gc-vs-major-gc-vs-full-gc.html)

 

三类GC：

1. Minor GC：清理年轻代内存空间中的短生命周期对象，在年轻代空间中的短生命周期的对象在被Minor      GC一定轮数（默认是15）后，会被转入老年代空间，判断为长生命周期对象。这类GC由于绝大多数都是短生命周期的对象，因此通常处理是很快的，因此其Stop      the World操作带来的影响很小。在Eden内存空间满时被促发。
2. Major GC：清理老年代内存空间，老年代空间中的对象都是相对长生命周期的对象，因此处理起来相对耗时。
3. Full GC：将清理年轻代、老年代、永久代所有内存空间的对象，这也是为什么静态对象可能被回收。

 

## 三、垃圾回收算法

垃圾回收具体流程一般分成三步：

1. 标记处需要被回收的对象
2. 回收被标记的对象空间
3. 将回收的对象空间移动为连续的内存块便于分配给新的对象。

 

#### 对象已死吗？

**引用计数算法：**给对象添加一个引用计数器，每当有一个地方引用它时，计数器值就加1；当引用失效时，计数器值就减1；任何时刻计数器为0的对象就是不可能再被使用的。

存在的问题：很难解决对象循环引用的问题。主流的Java虚拟机实现中没有使用该算法。

 

**可达性分析算法：**通过一系列的称为“GC Roots”的对象作为起始点，从这些节点开始向下搜索，搜索所走过的路径称为引用链，当一个对象到GC Rootsmeiyou 没有任何引用链相连时，则证明此对象是不可用的。

**可作为根节点的对象：**

1. 虚拟机栈（栈帧中的本地变量表）中引用的对象
2. 方法区中类静态属性引用的对象
3. 方法区中常量引用的对象
4. 本地方法栈中JNI（即一般说的Native方法）引用的对象

#### 垃圾收集算法

**标记清除算法**：首先标记出所有需要回收的对象，在标记完成后统一回收所有被标记的对象。

**不足：**标记和清除的效率不高。标记清除后会产生大量的不连续的内存碎片。空间碎片太多可能会导致以后在程序运行过程中需要分配较大对象时，无法找到足够的连续内存而不得不提前触发另一次垃圾收集动作。


**复制算法：**将可用内存按容量划分成大小相等的两块，每次只使用其中的的一块。当这一块的内存用完了，就将还存活着的对象复制到另外一块上面，然后再把已使用过的内存空间一次清理掉。这样使得每次都是对整个半区进行内存回收，内存分配时也就不用考虑内存碎片等复杂情况，只要移动堆顶指针，按顺序分配内存即可，实现简单，运行高效。

**商业使用：**新生代中的对象98%是“朝生夕死”的，所以并不需要按照1:1的比例来划分内存空间，而是将内存分为一块较大的Eden空间和两块较小的Survivor空间，每次使用Eden和其中一块Survivor。当回收时，将Eden和Survivor中还存活着的对象一次性地复制到另外一块Survivor空间上，最后清理掉Eden和刚才使用过的Survivor空间。默认是8:1.


**标记-整理算法：**标记过程仍然与“标记-清除”算法一样，但后续步骤不是直接对可回收对象进行清理，而是让所有存活的对象都向一端移动，然后直接清理掉断边界意外的内存。


参考文章：

1. <https://blog.dreamtobe.cn/jmm/>
2. 《深入理解java虚拟机》第二版